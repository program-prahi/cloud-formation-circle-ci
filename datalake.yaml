AWSTemplateFormatVersion: '2010-09-09'
Description: DataLake Creation
Parameters:
      ENVIRONMENT: 
        Type: String    
        AllowedValues:
        - dev
        - qa
        - staging
        - production
      COMPANYNAME: 
        AllowedPattern: ^[a-z]+([a-z-]*[a-z])*$
        ConstraintDescription: Company name can include lowercase letters and hyphens (-). 
          It cannot start or end with a hyphen (-).
        Default: s3
        Description: "Naming conventions for the company"
        Type: String   
      CodaS3BucketName:
        Default: s3-datalake-templates-dev-394780878318
        Description: "S3 bucket where the Quick Start templates and scripts are installed.\
          \ Use this parameter to specify the S3 bucket name you\u2019ve created for your\
          \ copy of Quick Start assets, if you decide to customize or extend the Quick\
          \ Start for your own use. The bucket name can include numbers, lowercase letters,\
          \ uppercase letters, and hyphens, but should not start or end with a hyphen."
        Type: String
      CodaS3KeyPrefix:
        Default: datalake/
        Description: S3 key prefix used to simulate a folder for your copy of Quick Start
          assets, if you decide to customize or extend the Quick Start for your own use.
          This prefix can include numbers, lowercase letters, uppercase letters, hyphens,
          and forward slashes.
        Type: String
      OWNER: 
        Type: String
        Default: 'Jacob Puthuparambil'
        Description: "The labeled owner for tagging purposes"
      ProjectName:
        Type: String
        Description: Name of the project
        Default: datalake
      VpcCIDR:
        Description: Please enter the IP range (CIDR notation) for this VPC
        Type: String
        Default: 10.192.0.0/16
        AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
  
      PublicSubnet1CIDR:
        Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone
        Type: String
        Default: 10.192.50.0/24
        AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
      PublicSubnet2CIDR:
        Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone
        Type: String
        Default: 10.192.40.0/24
        AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
      ReplicationInstanceClass:
        Type: String
        Description: Instance type of Replication Instance.
        AllowedValues:
            - dms.t2.micro
            - dms.t2.small
            - dms.t2.medium
            - dms.t2.large
            - dms.c4.large
            - dms.c4.xlarge
            - dms.c4.2xlarge
            - dms.c4.4xlarge
        Default: dms.c4.2xlarge
      EndpointBucketFolder:
        Type: String
        Description: Prefix of raw bucket where the full load data populated
        Default: fig_full_load
      Username:
        Type: String
        Description: Username of the Database
        Default: awsdatalake
      Password:
          Type: String
          NoEcho: true
          Description: Password of the Database
      Engine:
          Type: String
          Description: Engine type of the Database
          Default: mysql
      Host:
          Type: String
          Description: Host IP of the Database
          Default: 34.74.194.212
      Port:
          Type: String
          Description: Port number of the Database
          Default: 3306
      DBName: 
          Type: String
          Description: Name of the Database
          Default: FILU
      RawInputDatabaseName: 
          Type: String
          Description: The database name for the input of the job
          Default: s3_dev_filu_db_raw
      TransientInputDatabaseName: 
          Type: String
          Description: The database name for the input of the job
          Default: s3_dev_filu_db_transient
      RefinedInputDatabaseName: 
          Type: String
          Description: The database name for the input of the job
          Default: s3_dev_filu_db_refined
      EmailID:
        Type: String
        Description: Email ID for sns to notify the glue workflow failure.
Resources:
    KmsKey: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                ProjectName: !Ref 'ProjectName'
                OWNER: !Ref 'OWNER'
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}kms.yaml'
        Type: AWS::CloudFormation::Stack
    BucketsRaw:
        Properties:
            Parameters:
                BUCKETNAME: !Sub '${COMPANYNAME}-${ProjectName}-raw-${ENVIRONMENT}-${AWS::AccountId}'
                ENVIRONMENT: !Sub '${ENVIRONMENT}'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref 'ProjectName'
                COMPANYNAME: !Ref 'COMPANYNAME'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                USELIFECYCLE: 'yes'
                Versioning: Enabled
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}bucket.yaml'
        Type: AWS::CloudFormation::Stack
    AthenaQueryResultsBucket:
      Properties:
          Parameters:
              BUCKETNAME: !Sub '${COMPANYNAME}-${ProjectName}-athena-query-results-${ENVIRONMENT}-${AWS::AccountId}'
              ENVIRONMENT: !Sub '${ENVIRONMENT}'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref 'ProjectName'
              COMPANYNAME: !Ref 'COMPANYNAME'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              USELIFECYCLE: 'yes'
              Versioning: Suspended    
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}bucket.yaml'
      Type: AWS::CloudFormation::Stack
    TransientBucket:
      Properties:
          Parameters:
              BUCKETNAME: !Sub '${COMPANYNAME}-${ProjectName}-transient-${ENVIRONMENT}-${AWS::AccountId}'
              ENVIRONMENT: !Sub '${ENVIRONMENT}'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref 'ProjectName'
              COMPANYNAME: !Ref 'COMPANYNAME'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              USELIFECYCLE: 'yes'
              Versioning: Suspended
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}bucket.yaml'
      Type: AWS::CloudFormation::Stack
    TemporaryBucket:
      Properties:
          Parameters:
              BUCKETNAME: !Sub '${COMPANYNAME}-${ProjectName}-glue-temporary-${ENVIRONMENT}-${AWS::AccountId}'
              ENVIRONMENT: !Sub '${ENVIRONMENT}'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref 'ProjectName'
              COMPANYNAME: !Ref 'COMPANYNAME'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              USELIFECYCLE: 'yes'
              Versioning: Suspended
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}bucket.yaml'
      Type: AWS::CloudFormation::Stack
    BucketsRefined:
      Properties:
          Parameters:
              BUCKETNAME: !Sub '${COMPANYNAME}-${ProjectName}-refined-${ENVIRONMENT}-${AWS::AccountId}'
              ENVIRONMENT: !Sub '${ENVIRONMENT}'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref 'ProjectName'
              COMPANYNAME: !Ref 'COMPANYNAME'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              USELIFECYCLE: 'yes'
              Versioning: Enabled
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}bucket.yaml'
      Type: AWS::CloudFormation::Stack
    KinesisStream:
      Properties:
        Parameters:
          ENVIRONMENT: !Sub '${ENVIRONMENT}'
          OWNER: !Ref 'OWNER'
          ProjectName: !Ref 'ProjectName'
          COMPANYNAME: !Ref 'COMPANYNAME'
          KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
          KinesisDataStreamName: !Sub '${ProjectName}-raw-${ENVIRONMENT}-${AWS::AccountId}-Stream'
        TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}kinesis-datastream.yaml'
      Type: AWS::CloudFormation::Stack

    KinesisFirehose:
      Properties:
        Parameters:
          ENVIRONMENT: !Sub '${ENVIRONMENT}'
          OWNER: !Ref 'OWNER'
          ProjectName: !Ref 'ProjectName'
          COMPANYNAME: !Ref 'COMPANYNAME'
          DeliveryStreamName: !Sub '${ProjectName}-${ENVIRONMENT}-${AWS::AccountId}-DeliveryStream'
          KinesisStreamARN: !GetAtt 'KinesisStream.Outputs.DataStreamARN'
          RawZoneBucketName: !GetAtt 'BucketsRaw.Outputs.S3BucketName'
          KmsKeyArn: !GetAtt 'KmsKey.Outputs.KeyArn'
        TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}kinesis-firehose.yaml'
      Type: AWS::CloudFormation::Stack
    VpcTemplate:
      Type: AWS::CloudFormation::Stack
      Properties:
        Parameters:
          CompanyName: !Ref COMPANYNAME
          Owner: !Ref OWNER
          Environment: !Ref ENVIRONMENT
          ProjectName: !Ref ProjectName
          VpcCIDR: !Ref VpcCIDR
          Host: !Ref Host
          PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
          PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.${AWS::Region}.amazonaws.com/${CodaS3KeyPrefix}vpc.yaml'
    ReplicationInstance:
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              ProjectName: !Ref 'ProjectName'
              OWNER: !Ref 'OWNER'
              PublicSubnet1Id: !GetAtt 'VpcTemplate.Outputs.PublicSubnet1'
              PublicSubnet2Id: !GetAtt 'VpcTemplate.Outputs.PublicSubnet2'
              ReplicationInstanceClass: !Ref ReplicationInstanceClass
              KmsKeyId: !GetAtt 'KmsKey.Outputs.KeyId'
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}dmsreplicationinstance.yaml'
      Type: AWS::CloudFormation::Stack
    DMSSNSTopic:
      Properties: 
        Parameters: 
            ENVIRONMENT: !Ref 'ENVIRONMENT'
            COMPANYNAME: !Ref 'COMPANYNAME'
            ProjectName: !Ref 'ProjectName'
            OWNER: !Ref 'OWNER'
            TOPICNAME: !Sub '${ProjectName}-${ENVIRONMENT}-dms-sns-topic' 
            DISPLAYNAME: !Sub '${ProjectName}-${ENVIRONMENT}-dms-sns' 
            KMSKEYID: !GetAtt 'KmsKey.Outputs.KeyId'
        TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}dms-sns-topic.yaml'
      Type: AWS::CloudFormation::Stack
    
    DBSecret: 
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              ProjectName: !Ref 'ProjectName'
              OWNER: !Ref 'OWNER'
              Username: !Ref Username
              Password: !Ref Password
              Host: !Ref Host
              Port: !Ref Port
              Engine: !Ref Engine
              DBName: !Ref DBName
              KmsKeyId: !GetAtt 'KmsKey.Outputs.KeyId'
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}secret.yaml'
      Type: AWS::CloudFormation::Stack  
    DMSEndpoint:
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              ProjectName: !Ref 'ProjectName'
              OWNER: !Ref 'OWNER'
              KMSId: !GetAtt 'KmsKey.Outputs.KeyId'
              DMSEndpointName: !Sub '${ProjectName}-${ENVIRONMENT}'
              KinesisStreamArn: !GetAtt 'KinesisStream.Outputs.DataStreamARN'
              RawBucketName: !GetAtt 'BucketsRaw.Outputs.S3BucketName'
              BucketFolder: !Ref EndpointBucketFolder
              SourceDBSecretArn: !GetAtt 'DBSecret.Outputs.DBSecretArn'
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}dms-endpoint.yaml'
      Type: AWS::CloudFormation::Stack
    DMSTasks:
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              ProjectName: !Ref 'ProjectName'
              OWNER: !Ref 'OWNER'
              ReplicationInstanceArn: !GetAtt ReplicationInstance.Outputs.ReplicationInstanceARN
              DMSTaskName: !Sub '${ProjectName}-${ENVIRONMENT}'
              DMSKinesisSourceEndpointArn: !GetAtt DMSEndpoint.Outputs.SourceEndpointArn
              DMSKinesisTargetEndpointArn: !GetAtt DMSEndpoint.Outputs.DMSKinesisEndpointArn
              DMSS3SourceEndpointArn: !GetAtt DMSEndpoint.Outputs.SourceEndpointArn
              DMSS3TargetEndpointArn: !GetAtt DMSEndpoint.Outputs.DMSS3EndpointArn
              SnsTopicArn: !GetAtt DMSSNSTopic.Outputs.TopicArn
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}dms-tasks.yaml'
      Type: AWS::CloudFormation::Stack
    GlueRole: 
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              TransientBucketARN: !GetAtt 'TransientBucket.Outputs.S3BucketARN'
              RawBucketARN: !GetAtt 'BucketsRaw.Outputs.S3BucketARN'
              KmsKeyArn: !GetAtt 'KmsKey.Outputs.KeyArn'
              GlueTempBucketARN: !GetAtt 'TemporaryBucket.Outputs.S3BucketARN'
              GlueScriptsBucketARN: !Sub 'arn:aws:s3:::${CodaS3BucketName}'
              RefinedBucketARN: !GetAtt 'BucketsRefined.Outputs.S3BucketARN'
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}iam.yaml'
      Type: AWS::CloudFormation::Stack
    RawS3Crawler:
      Properties:
          Parameters:
              CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-raw-Crawler'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
              DATABASENAME: !Ref RawInputDatabaseName
              SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueRawCrawlerRoleARN'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              TypeOfConnectionToCrawl: s3
              S3ConnectionInformation: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'BucketsRaw.Outputs.S3BucketName'
                  - '/'
                  - !Ref EndpointBucketFolder
                  - '/'
              TypeofZone: raw
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
      Type: AWS::CloudFormation::Stack
    TransientS3Crawler:
      Properties:
          Parameters:
              CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-transient-Crawler'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
              DATABASENAME: !Ref TransientInputDatabaseName
              SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueTransientCrawlerRoleArn'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              TypeOfConnectionToCrawl: s3
              S3ConnectionInformation: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TransientBucket.Outputs.S3BucketName'
                  - '/FILU/'
              TypeofZone: transient
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
      Type: AWS::CloudFormation::Stack
    # TransientS3CrawlerUpdates:
    #   Properties:
    #       Parameters:
    #           CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-transient-updates-Crawler'
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           DATABASENAME: !Sub '${TransientInputDatabaseName}_cdc_updates'
    #           SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueTransientCrawlerRoleArn'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           TypeOfConnectionToCrawl: s3
    #           S3ConnectionInformation: !Join
    #             - ''
    #             - - 's3://'
    #               - !GetAtt 'TransientBucket.Outputs.S3BucketName'
    #               - '/FILU_Update/'
    #           TypeofZone: transient
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
    #   Type: AWS::CloudFormation::Stack
    
    RefinedS3Crawler:
      Properties:
          Parameters:
              CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-refined-Crawler'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
              DATABASENAME: !Ref RefinedInputDatabaseName
              SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueRefinedCrawlerRoleArn'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              TypeOfConnectionToCrawl: s3
              S3ConnectionInformation: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                  - '/FIGAudit/FIG/'
              TypeofZone: refined
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
      Type: AWS::CloudFormation::Stack
    # RefinedS3CrawlerUpdates:
    #   Properties:
    #       Parameters:
    #           CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-refined-updates-Crawler'
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           DATABASENAME: !Sub '${RefinedInputDatabaseName}_update'
    #           SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueRefinedCrawlerRoleArn'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           TypeOfConnectionToCrawl: s3
    #           S3ConnectionInformation: !Join
    #             - ''
    #             - - 's3://'
    #               - !GetAtt 'BucketsRefined.Outputs.S3BucketName'
    #               - '/FIG_Update/'
    #           TypeofZone: refined_updates
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
    #   Type: AWS::CloudFormation::Stack
    # CDCCrawler:
    #   Properties:
    #       Parameters:
    #           CrawlerName: !Sub '${ProjectName}-${ENVIRONMENT}-cdc-Crawler'
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           SERVICEROLEARN: !GetAtt 'GlueRole.Outputs.AWSGlueRawCrawlerRoleARN'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           CDCDatabaseName: !GetAtt 'KinesisFirehose.Outputs.DBName'
    #           CDCTableName: !GetAtt 'KinesisFirehose.Outputs.TableName'
    #           TypeOfConnectionToCrawl: table
    #           TypeofZone: cdc
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-crawler.yaml'
    #   Type: AWS::CloudFormation::Stack
    CDCGlueJob: 
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
              NAME: !Sub '${ProjectName}-${ENVIRONMENT}-cdc-job'
              AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_cdc_raw_to_transient.py' 
              TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
              InputDatabase: !GetAtt 'KinesisFirehose.Outputs.DBName'
              InputTable: !GetAtt 'KinesisFirehose.Outputs.TableName'
              OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
              OutputPath: FILU
              TypeOfJob: cdc
              TypeOfOperation: insert
              WorkerType: Standard
              DpuCount: 30              
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
      Type: AWS::CloudFormation::Stack

    # CDCUpdateGlueJob: 
    #   Properties: 
    #       Parameters: 
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           NAME: cdc-update-job
    #           AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           ScriptPath: !Join
    #             - ''  
    #             - - 's3://'
    #               - !Ref 'CodaS3BucketName'
    #               - '/scripts/ingest_cdc_raw_to_transient.py' 
    #           TempDirectory: !Join
    #             - ''
    #             - - 's3://'
    #               - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
    #               - '/temp-dir'
    #           InputDatabase: !GetAtt 'KinesisFirehose.Outputs.DBName'
    #           InputTable: !GetAtt 'KinesisFirehose.Outputs.TableName'
    #           OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
    #           OutputPath: FILU_Update
    #           TypeOfJob: cdc
    #           TypeOfOperation: update
    #           WorkerType: Standard
    #           DpuCount: 20               
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
    #   Type: AWS::CloudFormation::Stack

    tdemographicsurveyGlueJob: 
      Properties: 
          Parameters: 
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
              NAME: t_demographic_survey-job
              AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
              KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
              ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
              TempDirectory: !Join
              - ''
              - - 's3://'
                - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                - '/temp-dir'
              InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
              InputTable: t_demographic_survey
              OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
              OutputPath: FILU
              WorkerType: G.1X
              DpuCount: 50
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
      Type: AWS::CloudFormation::Stack
    tdemographictagvalueGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag_value-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag_value
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tdemographicsurveyvalueGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_survey_value-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_survey_value
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tdemographicsurveyattributeGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_survey_attribute-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_survey_attribute
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tdemographictagattributeGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag_attribute-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag_attribute
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
                WorkerType: Standard
                DpuCount: 10                
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tvisitedaffiliateGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_visited_affiliate-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_visited_affiliate
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
                WorkerType: G.1X
                DpuCount: 50                
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tdemographicGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tdemographictagGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tbaseidGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_baseid-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py' 
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_baseid
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    tsubscribedofferGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_subscribed_offer-job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_raw_to_transient.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'RawS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_subscribed_offer
                OutputBucket: !GetAtt 'TransientBucket.Outputs.S3BucketName'
                OutputPath: FILU
                WorkerType: G.1X
                DpuCount: 50                
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    ProcessingWorkflow:
        Properties:
            Parameters:
                WorkflowName: 'raw-to-transient'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-workflow.yaml'
        Type: AWS::CloudFormation::Stack
    LambdaFunction:
        Properties:
            Parameters:
                GlueWorkflowName: !GetAtt ProcessingWorkflow.Outputs.WorkflowId
                DMSTaskArn: !GetAtt DMSTasks.Outputs.DMSCDCTaskArn
                SNSTopic: !GetAtt DMSSNSTopic.Outputs.TopicArn
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                CodaS3BucketName: !Ref CodaS3BucketName
                LambdaScriptPath: scripts/full-load-glue-lambda.zip
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}lambdaNotification.yaml'
        Type: AWS::CloudFormation::Stack
    ProcessingCDCWorkflow:
      Properties:
          Parameters:
              WorkflowName: 'cdc-raw-to-transient'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-workflow.yaml'
      Type: AWS::CloudFormation::Stack
    ImportRawDataTrigger:
        Type: AWS::Glue::Trigger
        DependsOn:
          - tdemographicsurveyGlueJob
          - tdemographictagvalueGlueJob
          - tdemographicsurveyvalueGlueJob
          - tdemographicsurveyattributeGlueJob
          - tdemographictagattributeGlueJob
          - tvisitedaffiliateGlueJob
          - tdemographicGlueJob
          - tdemographictagGlueJob
          - tbaseidGlueJob
          - tsubscribedofferGlueJob
        Properties:
            Type: CONDITIONAL
            Description: !Join
                - ''
                - - 'Starts the '
                  - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                  - ' ingest raw zone data.'
            WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
            StartOnCreation: true
            Name: !Join
                - '-'
                - - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                  - raw-plain-etl 
            Predicate:
                Conditions:
                    - LogicalOperator: EQUALS
                      CrawlerName: !GetAtt RawS3Crawler.Outputs.CrawlerName
                      CrawlState: SUCCEEDED
            Actions:
              - JobName: !GetAtt tdemographicsurveyGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagvalueGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicsurveyvalueGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicsurveyattributeGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagattributeGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tvisitedaffiliateGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tbaseidGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tsubscribedofferGlueJob.Outputs.GlueJob
            Tags:
                WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'

    WorkflowKickOffTrigger:
        Type: AWS::Glue::Trigger
        DependsOn:
          - tdemographicsurveyGlueJob
          - tdemographictagvalueGlueJob
          - tdemographicsurveyvalueGlueJob
          - tdemographicsurveyattributeGlueJob
          - tdemographictagattributeGlueJob
          - tvisitedaffiliateGlueJob
          - tdemographicGlueJob
          - tdemographictagGlueJob
          - tbaseidGlueJob
          - tsubscribedofferGlueJob
        Properties:
            Type: ON_DEMAND
            WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
            Name: !Join
                - '-'
                - - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                  - kickoff
            Actions:
                - CrawlerName: !GetAtt RawS3Crawler.Outputs.CrawlerName
            Tags:
                WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'            
    CDCJobTrigger:
      Type: AWS::Glue::Trigger
      DependsOn:
        - ProcessingCDCWorkflow
        - ProcessingWorkflow
        - ImportRawDataTrigger
      Properties:
        Type: SCHEDULED
        Description: !Join 
        - ''
        - - 'Starts the ' 
          - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId' 
          - ' cdc glue job'
        WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'    
        StartOnCreation: true 
        Schedule: cron(0 4 * * ? *)
        Name: !Join
          - '-'
          - - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId' 
            - start-cdc-job
        Actions:
          - JobName: !GetAtt CDCGlueJob.Outputs.GlueJob
          # - JobName: !GetAtt CDCUpdateGlueJob.Outputs.GlueJob
        Tags:
          WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'
          ENVIRONMENT: !Ref 'ENVIRONMENT'
          COMPANYNAME: !Ref 'COMPANYNAME'
          OWNER: !Ref 'OWNER'
    # TransientUpdateTrigger:
    #   Type: AWS::Glue::Trigger
    #   DependsOn:
    #     - ProcessingCDCWorkflow
    #     - ProcessingWorkflow
    #     - ImportRawDataTrigger
    #     - CDCJobTrigger
    #     - TransientCrawlerTrigger
    #   Properties:
    #     Type: CONDITIONAL
    #     Description: !Join 
    #     - ''
    #     - - 'Starts the ' 
    #       - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId' 
    #       - ' transient updates crawler'
    #     WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'    
    #     StartOnCreation: true 
    #     Name: !Join
    #       - '-'
    #       - - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId' 
    #         - start-transient-update-crawler
    #     Predicate:
    #       Conditions:
    #           - LogicalOperator: EQUALS
    #             JobName: !GetAtt CDCUpdateGlueJob.Outputs.GlueJob
    #             State: SUCCEEDED
    #     Actions:
    #       - CrawlerName: !GetAtt TransientS3CrawlerUpdates.Outputs.CrawlerName
    #     Tags:
    #       WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'
    #       ENVIRONMENT: !Ref 'ENVIRONMENT'
    #       COMPANYNAME: !Ref 'COMPANYNAME'
    #       OWNER: !Ref 'OWNER'
    TransientCrawlerTrigger:
      Type: AWS::Glue::Trigger
      DependsOn:
        - ProcessingCDCWorkflow
        - ProcessingWorkflow
        - ImportRawDataTrigger
        - CDCJobTrigger
      Properties:
        Type: CONDITIONAL
        Description: !Join 
        - ''
        - - 'Starts the ' 
          - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId' 
          - ' transient crawler'
        WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'    
        StartOnCreation: true 
        Name: !Join
          - '-'
          - - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId' 
            - start-transient-crawler
        Predicate:
          Conditions:
              - LogicalOperator: EQUALS
                JobName: !GetAtt CDCGlueJob.Outputs.GlueJob
                State: SUCCEEDED
        Actions:
          - CrawlerName: !GetAtt TransientS3Crawler.Outputs.CrawlerName
        Tags:
          WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'
          ENVIRONMENT: !Ref 'ENVIRONMENT'
          COMPANYNAME: !Ref 'COMPANYNAME'
          OWNER: !Ref 'OWNER'
    FailureSNS:
      Properties:
        Parameters:
          ENVIRONMENT: !Ref 'ENVIRONMENT'
          COMPANYNAME: !Ref 'COMPANYNAME'
          ProjectName: !Ref 'ProjectName'
          OWNER: !Ref 'OWNER'
          TOPICNAME: !Sub '${ProjectName}-${ENVIRONMENT}-sns-workflow-topic'
          DISPLAYNAME: !Sub '${ProjectName}-${ENVIRONMENT}-workflow-sns' 
          KMSKEYID: !GetAtt 'KmsKey.Outputs.KeyId'
          EmailID: !Ref EmailID
        TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}sns.yaml'
      Type: AWS::CloudFormation::Stack
    WorkflowFailureTrigger:
        Type: AWS::Glue::Trigger
        DependsOn:
          - tdemographicsurveyGlueJob
          - tdemographictagvalueGlueJob
          - tdemographicsurveyvalueGlueJob
          - tdemographicsurveyattributeGlueJob
          - tdemographictagattributeGlueJob
          - tvisitedaffiliateGlueJob
          - tdemographicGlueJob
          - tdemographictagGlueJob
          - tbaseidGlueJob
          - tsubscribedofferGlueJob
          - FailureJob
        Properties:
            Type: CONDITIONAL
            Description: !Join
                - ''
                - - 'Sends the notification that '
                  - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                  - ' has a failure somewhere'
            WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
            StartOnCreation: true
            Name: !Join
                - '-'
                - - !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                  - failure-state-plain-etl
            Predicate:
                Logical: ANY
                Conditions:
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographicsurveyGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographictagvalueGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographicsurveyvalueGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographicsurveyattributeGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographictagattributeGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tvisitedaffiliateGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographicGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tdemographictagGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tbaseidGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      JobName: !GetAtt tsubscribedofferGlueJob.Outputs.GlueJob
                      State: FAILED
                    - LogicalOperator: EQUALS
                      CrawlerName: !GetAtt RawS3Crawler.Outputs.CrawlerName
                      CrawlState: FAILED
            Actions:
              - JobName: !GetAtt FailureJob.Outputs.GlueJob
            Tags:
                WorkflowName: !GetAtt 'ProcessingWorkflow.Outputs.WorkflowId'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
    RefinedWorkflowKickoffTrigger:
        Type: AWS::Glue::Trigger
        DependsOn:
          - ProcessingRefinedWkflowKickoffJob
          - ProcessingRefinedWorkflow
          - ProcessingCDCWorkflow
        Properties:
            Type: CONDITIONAL
            Description: !Join
                - ''
                - - 'Starts the '
                  - !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                  
            WorkflowName: !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'
            StartOnCreation: 'true'
            Name: !Join
                - '-'
                - - !GetAtt 'ProcessingCDCWorkflow.Outputs.WorkflowId'
                  - 'starts-refined-workflow'
            Predicate:
                Logical: AND
                Conditions:
                    - LogicalOperator: EQUALS
                      CrawlerName: !GetAtt TransientS3Crawler.Outputs.CrawlerName
                      CrawlState: SUCCEEDED
                    # - LogicalOperator: EQUALS
                    #   CrawlerName: !GetAtt TransientS3CrawlerUpdates.Outputs.CrawlerName
                    #   CrawlState: SUCCEEDED
            Actions:
              - JobName: !GetAtt ProcessingRefinedWkflowKickoffJob.Outputs.GlueJob
            Tags:
                WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
    ProcessingRefinedWkflowKickoffJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: RefinedWorkflowKickoff
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/workflow_success.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: 'None'
                InputTable: 'None'
                OutputBucket: 'None'
                OutputPath: 'None'
                WORKFLOWID: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    FailureJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: failure_job
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/workflow_failure.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: 'None'
                InputTable: 'None'
                OutputBucket: 'None'
                OutputPath: 'None'
                SnsArn: !GetAtt 'FailureSNS.Outputs.TopicArn'
                WorkerType: Standard
                DpuCount: 10
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    ProcessingRefinedWorkflow:
      Properties:
          Parameters:
              WorkflowName: 'transient-to-refined'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'
              ProjectName: !Ref ProjectName
          TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-workflow.yaml'
      Type: AWS::CloudFormation::Stack
    ImportTransientToRefinedTrigger:
        Type: AWS::Glue::Trigger
        DependsOn:
          - tbaseidRefinedGlueJob
          - tdemographicRefinedGlueJob
          - tdemographicsurveyRefinedGlueJob
          - tdemographicsurveyattrRefinedGlueJob
          - tdemographicsurveyvalRefinedGlueJob
          - tdemographictagRefinedGlueJob
          - tdemographictagattribRefinedGlueJob
          - tdemographictagvalueRefinedGlueJob
          - tsubscribedofferRefinedGlueJob
          - tvisitedaffiliateRefinedGlueJob
          # - tdemographicupdatesGlueJob
          # - tdemographictagupdatesGlueJob
          # - tdemographicsurveyupdatesGlueJob
        Properties:
            Type: ON_DEMAND
            Description: !Join
                - ''
                - - 'Starts the '
                  - !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                  
            WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
            # StartOnCreation: 'true'
            Name: !Join
                - '-'
                - - !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                  - transient-refined-plain-etl
            Actions:
              - JobName: !GetAtt tbaseidRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicsurveyRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicsurveyattrRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographicsurveyvalRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagattribRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tdemographictagvalueRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tsubscribedofferRefinedGlueJob.Outputs.GlueJob
              - JobName: !GetAtt tvisitedaffiliateRefinedGlueJob.Outputs.GlueJob
              # - JobName: !GetAtt 'tdemographicupdatesGlueJob.Outputs.GlueJob'
              # - JobName: !GetAtt 'tdemographictagupdatesGlueJob.Outputs.GlueJob'
              # - JobName: !GetAtt 'tdemographicsurveyupdatesGlueJob.Outputs.GlueJob'
            Tags:
                WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
    RefinedCrawlerKickoffTrigger:
      Type: AWS::Glue::Trigger
      DependsOn:
        - RefinedS3Crawler
        - ImportTransientToRefinedTrigger
      Properties:
          Type: CONDITIONAL
          Description: !Join
              - ''
              - - 'Starts the '
                - !GetAtt 'RefinedS3Crawler.Outputs.CrawlerName'
          WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
          StartOnCreation: 'true'
          Name: !Join
              - '-'
              - - !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
                - refined-crawler-trigger
          Predicate:
              Logical: AND
              Conditions:
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tbaseidRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographicRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographicsurveyRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographicsurveyattrRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographicsurveyvalRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographictagRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographictagattribRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tdemographictagvalueRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tsubscribedofferRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
                - LogicalOperator: EQUALS
                  JobName: !GetAtt tvisitedaffiliateRefinedGlueJob.Outputs.GlueJob
                  State: SUCCEEDED
          Actions:
              - CrawlerName: !GetAtt 'RefinedS3Crawler.Outputs.CrawlerName'
          Tags:
              WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
              ENVIRONMENT: !Ref 'ENVIRONMENT'
              COMPANYNAME: !Ref 'COMPANYNAME'
              OWNER: !Ref 'OWNER'

    # RefinedUpdatesCrawlerKickoffTrigger:
    #   Type: AWS::Glue::Trigger
    #   DependsOn:
    #     - ImportTransientToRefinedTrigger
    #     - RefinedS3CrawlerUpdates
    #   Properties:
    #       Type: CONDITIONAL
    #       Description: !Join
    #           - ''
    #           - - 'Starts the '
    #             - !GetAtt 'RefinedS3CrawlerUpdates.Outputs.CrawlerName'
    #       WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
    #       StartOnCreation: 'true'
    #       Name: !Join
    #           - '-'
    #           - - !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
    #             - refined-update-crawler-trigger
    #       Predicate:
    #           Logical: AND
    #           Conditions:
    #             - LogicalOperator: EQUALS
    #               JobName: !GetAtt 'tdemographicupdatesGlueJob.Outputs.GlueJob'
    #               State: SUCCEEDED
    #             - LogicalOperator: EQUALS
    #               JobName: !GetAtt 'tdemographictagupdatesGlueJob.Outputs.GlueJob'
    #               State: SUCCEEDED
    #             - LogicalOperator: EQUALS
    #               JobName: !GetAtt 'tdemographicsurveyupdatesGlueJob.Outputs.GlueJob'
    #               State: SUCCEEDED
    #       Actions:
    #           - CrawlerName: !GetAtt 'RefinedS3CrawlerUpdates.Outputs.RefinedUpdatesCrawler'
    #       Tags:
    #           WorkflowName: !GetAtt 'ProcessingRefinedWorkflow.Outputs.WorkflowId'
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'

    tbaseidRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_baseid-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_baseid
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographicRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographicsurveyRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_survey-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_survey
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
                WorkerType: G.1X
                DpuCount: 50
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographicsurveyattrRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_survey_attr-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_survey_attribute
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographicsurveyvalRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_survey_val-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_survey_value
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
   
    tdemographictagRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographictagattribRefinedGlueJob: 
        Properties: 
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag_attr-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag_attribute
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                TypeOfJob: plain_refined
                FirstSource: FILU
                WorkerType: Standard
                DpuCount: 10                 
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tdemographictagvalueRefinedGlueJob:
        Properties:
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_demographic_tag_val-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_demographic_tag_value
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                FirstSource: FILU
                TypeOfJob: plain_refined
                OutputPath: FIGAudit/FIG
                WorkerType: Standard
                DpuCount: 10                    
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tsubscribedofferRefinedGlueJob:
        Properties:
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_subscribed_offer-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_subscribed_offer
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                TypeOfJob: plain_refined
                FirstSource: FILU
                OutputPath: FIGAudit/FIG
                WorkerType: G.1X
                DpuCount: 50                     
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack

    tvisitedaffiliateRefinedGlueJob:
        Properties:
            Parameters: 
                ENVIRONMENT: !Ref 'ENVIRONMENT'
                COMPANYNAME: !Ref 'COMPANYNAME'
                OWNER: !Ref 'OWNER'
                ProjectName: !Ref ProjectName
                NAME: t_visited_affiliate-p-trans-refined
                AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
                KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
                ScriptPath: !Join
                - ''  
                - - 's3://'
                  - !Ref 'CodaS3BucketName'
                  - '/scripts/ingest_plain_transient_to_refined.py'
                TempDirectory: !Join
                - ''
                - - 's3://'
                  - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
                  - '/temp-dir'
                InputDatabase: !GetAtt 'TransientS3Crawler.Outputs.GlueDatabaseName'
                InputTable: t_visited_affiliate
                OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
                OutputPath: FIGAudit/FIG
                FirstSource: FILU
                TypeOfJob: plain_refined
                WorkerType: G.1X
                DpuCount: 50                
            TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
        Type: AWS::CloudFormation::Stack
    # tdemographicsurveyupdatesGlueJob: 
    #   Properties: 
    #       Parameters: 
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           NAME: t_demographic_survey_update_job
    #           AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           ScriptPath: !Join
    #           - ''  
    #           - - 's3://'
    #             - !Ref 'CodaS3BucketName'
    #             - '/scripts/ingest_plain_transient_to_refined.py'
    #           TempDirectory: !Join
    #           - ''
    #           - - 's3://'
    #             - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
    #             - '/temp-dir'
    #           InputDatabase: !GetAtt 'TransientS3CrawlerUpdates.Outputs.GlueDatabaseName'
    #           InputTable: t_demographic_survey_cdc_update
    #           OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
    #           OutputPath: FIG_Update
    #           TypeOfJob: plain_refined
    #           FirstSource: FILU
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
    #   Type: AWS::CloudFormation::Stack
    # tdemographicupdatesGlueJob: 
    #   Properties: 
    #       Parameters: 
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           NAME: t_demographic_update_job
    #           AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           ScriptPath: !Join
    #           - ''  
    #           - - 's3://'
    #             - !Ref 'CodaS3BucketName'
    #             - '/scripts/ingest_plain_transient_to_refined.py'
    #           TempDirectory: !Join
    #           - ''
    #           - - 's3://'
    #             - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
    #             - '/temp-dir'
    #           InputDatabase: !GetAtt 'TransientS3CrawlerUpdates.Outputs.GlueDatabaseName'
    #           InputTable: t_demographic_cdc_update
    #           OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
    #           OutputPath: FIG_Update
    #           TypeOfJob: plain_refined
    #           FirstSource: FILU
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
    #   Type: AWS::CloudFormation::Stack
    # tdemographictagupdatesGlueJob: 
    #   Properties: 
    #       Parameters: 
    #           ENVIRONMENT: !Ref 'ENVIRONMENT'
    #           COMPANYNAME: !Ref 'COMPANYNAME'
    #           OWNER: !Ref 'OWNER'
    #           ProjectName: !Ref ProjectName
    #           NAME: t_demographic_tag_update_job
    #           AWSGlueJobRole: !GetAtt 'GlueRole.Outputs.glueEtlJobRoleARN'
    #           KMSARN: !GetAtt 'KmsKey.Outputs.KeyArn'
    #           ScriptPath: !Join
    #           - ''  
    #           - - 's3://'
    #             - !Ref 'CodaS3BucketName'
    #             - '/scripts/ingest_plain_transient_to_refined.py'
    #           TempDirectory: !Join
    #           - ''
    #           - - 's3://'
    #             - !GetAtt 'TemporaryBucket.Outputs.S3BucketName'
    #             - '/temp-dir'
    #           InputDatabase: !GetAtt 'TransientS3CrawlerUpdates.Outputs.GlueDatabaseName'
    #           InputTable: t_demographic_tag_cdc_update
    #           OutputBucket: !GetAtt 'BucketsRefined.Outputs.S3BucketName'
    #           OutputPath: FIG_Update
    #           TypeOfJob: plain_refined
    #           FirstSource: FILU
    #       TemplateURL: !Sub 'https://${CodaS3BucketName}.s3.amazonaws.com/${CodaS3KeyPrefix}glue-job.yaml'
    #   Type: AWS::CloudFormation::Stack

    AthenaWorkGroup:
        Type: AWS::Athena::WorkGroup
        Properties:
          Name: !Sub '${ProjectName}-${ENVIRONMENT}-athena-workgroup'
          Description: Athena workgroup for Querying The Zones of Datalake
          State: ENABLED
          Tags:
            - Key: 'Owner'
              Value: !Sub '${OWNER} - ${COMPANYNAME}'
            - Key: 'Environment'
              Value: !Ref ENVIRONMENT
            - Key: 'Project'
              Value: !Ref ProjectName
          WorkGroupConfigurationUpdates:
            BytesScannedCutoffPerQuery: 999999999
            EnforceWorkGroupConfiguration: true
            PublishCloudWatchMetricsEnabled: true
            RequesterPaysEnabled: false
            ResultConfigurationUpdates:
              EncryptionConfiguration:
                EncryptionOption: SSE_S3
              OutputLocation: !Join
                - ''  
                - - 's3://'
                  - !GetAtt 'AthenaQueryResultsBucket.Outputs.S3BucketName'
                  - '/query-results/'
Outputs:
  RawBucketName:
    Description: Bucket name for raw
    Value: !GetAtt 'BucketsRaw.Outputs.S3BucketName'
    Export: 
      Name: !Sub '${AWS::StackName}-RawBucketName'
  RawBucketARN:
    Description: Bucket ARN for raw
    Value: !GetAtt 'BucketsRaw.Outputs.S3BucketARN'
    Export: 
      Name: !Sub '${AWS::StackName}-RawBucketARN'
  KmsKeyArn:
    Description: The Key ARN for the KMS user defined key
    Value: !GetAtt 'KmsKey.Outputs.KeyArn'
    Export: 
      Name: !Sub '${AWS::StackName}-KmsKeyArn'
  KmsKeyId:
    Description: The Key Id for the KMS user defined key
    Value: !GetAtt 'KmsKey.Outputs.KeyId'
    Export: 
      Name: !Sub '${AWS::StackName}-KmsKeyId'
  KinesisStreamArn:
    Description: The Arn of Kinesis Stream
    Value: !GetAtt 'KinesisStream.Outputs.DataStreamARN'
    Export: 
      Name: !Sub '${AWS::StackName}-KinesisStreamArn'
  DeliveryStreamName:
    Description: Name of the Kinesis Firehose.
    Value: !GetAtt KinesisFirehose.Outputs.DeliveryStreamName
 